#!/usr/bin/env python3
# build_system.py - Sistema completo de build para Bagun√ßArt

import os
import subprocess
import sys
import shutil
import json
from datetime import datetime
from pathlib import Path

class BaguncartBuilder:
    """Sistema de build completo para Bagun√ßArt"""
    
    def __init__(self):
        self.project_name = "Bagun√ßArt"
        self.package_name = "baguncart"
        self.version = "2.0.0"
        self.build_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
    def setup_environment(self):
        """Configurar ambiente de desenvolvimento"""
        print("üîß Configurando ambiente Bagun√ßArt...")
        print("=" * 60)
        
        # Criar estrutura de pastas
        folders = [
            "src",
            "assets",
            "build",
            "dist",
            "docs",
            "tests"
        ]
        
        for folder in folders:
            os.makedirs(folder, exist_ok=True)
            print(f"üìÅ Pasta criada: {folder}")
        
        # Instalar depend√™ncias
        self.install_dependencies()
        
        # Criar arquivos de configura√ß√£o
        self.create_config_files()
        
        print("‚úÖ Ambiente configurado com sucesso!")
    
    def install_dependencies(self):
        """Instalar todas as depend√™ncias"""
        print("\nüì¶ Instalando depend√™ncias...")
        
        # Depend√™ncias principais
        main_deps = [
            "kivy>=2.2.0",
            "kivymd>=1.2.0",
            "mysql-connector-python>=8.0.33",
            "bcrypt>=4.0.1",
            "python-dotenv>=1.0.0",
            "requests>=2.31.0",
            "python-dateutil>=2.8.2",
            "pillow>=9.0.0"
        ]
        
        # Depend√™ncias de desenvolvimento
        dev_deps = [
            "buildozer",
            "pytest>=7.0.0",
            "black>=22.0.0",
            "flake8>=4.0.0",
            "mypy>=0.950"
        ]
        
        all_deps = main_deps + dev_deps
        
        for dep in all_deps:
            try:
                subprocess.check_call([sys.executable, "-m", "pip", "install", dep])
                print(f"‚úÖ {dep}")
            except subprocess.CalledProcessError:
                print(f"‚ùå Erro: {dep}")
    
    def create_config_files(self):
        """Criar arquivos de configura√ß√£o"""
        print("\nüìù Criando arquivos de configura√ß√£o...")
        
        # requirements.txt
        requirements = """# Bagun√ßArt Requirements
kivy>=2.2.0
kivymd>=1.2.0
mysql-connector-python>=8.0.33
bcrypt>=4.0.1
python-dotenv>=1.0.0
requests>=2.31.0
python-dateutil>=2.8.2
pillow>=9.0.0

# Development
buildozer
pytest>=7.0.0
black>=22.0.0
flake8>=4.0.0
mypy>=0.950
"""
        
        with open("requirements.txt", "w") as f:
            f.write(requirements)
        
        # .env template
        env_template = """# Bagun√ßArt Environment Variables
# Banco de dados
DB_HOST=mysql-baguncart-sistemabaguncart-19f5.h.aivencloud.com
DB_PORT=12983
DB_NAME=defaultdb
DB_USER=avnadmin
DB_PASSWORD=AVNS_rFX5xGI3Cb0fQMHWAhZ

# App
APP_NAME=Bagun√ßArt
APP_VERSION=2.0.0
DEBUG=True

# Security
JWT_SECRET=your-secret-key-here
ENCRYPTION_KEY=your-encryption-key-here
"""
        
        with open(".env", "w") as f:
            f.write(env_template)
        
        # buildozer.spec atualizado
        buildozer_spec = f"""[app]
title = {self.project_name} - Gest√£o de Eventos
package.name = {self.package_name}
package.domain = com.{self.package_name}.eventos

source.dir = .
source.include_exts = py,png,jpg,kv,atlas,txt,json

version = {self.version}
version.regex = __version__ = ['"]([^'"]*?)['"]
version.filename = %(source.dir)s/main.py

# KivyMD Requirements optimized for APK
requirements = python3,kivy==2.2.0,kivymd==1.2.0,mysql-connector-python,bcrypt,python-dotenv,requests,pillow,pyjnius,android

# Metadados
author = Bagun√ßArt Eventos
description = Sistema profissional de gest√£o de eventos com Material Design 3, transpar√™ncia total e automa√ß√£o inteligente

[buildozer]
log_level = 2
warn_on_root = 1

[android]
fullscreen = 0
orientation = portrait
android.permissions = INTERNET,ACCESS_NETWORK_STATE,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,ACCESS_WIFI_STATE,CAMERA,RECORD_AUDIO

# Icons and splash
icon.filename = %(source.dir)s/assets/icon.png
presplash.filename = %(source.dir)s/assets/presplash.png

# Android versions
android.api = 33
android.minapi = 21
android.ndk = 25b
android.sdk = 33

# Build settings
android.gradle_dependencies = 
android.add_src = 
android.add_java_dir = 
android.add_res_dir = 
android.add_assets_dir = 

# Architectures
android.archs = arm64-v8a, armeabi-v7a

# Release settings
android.release_artifact = apk
android.debug_artifact = apk

# Signing (uncomment for release)
# android.release_keystore = %(source.dir)s/release.keystore
# android.release_keyalias = {self.package_name}
# android.release_keystore_passwd = your_keystore_password
# android.release_keyalias_passwd = your_alias_password

[ios]
ios.kivy_ios_url = https://github.com/kivy/kivy-ios
ios.kivy_ios_branch = master
ios.ios_deploy_url = https://github.com/phonegap/ios-deploy
ios.ios_deploy_branch = 1.7.0
"""
        
        with open("buildozer.spec", "w") as f:
            f.write(buildozer_spec)
        
        print("‚úÖ Arquivos de configura√ß√£o criados")
    
    def create_assets(self):
        """Criar assets (√≠cones, imagens)"""
        print("\nüé® Criando assets...")
        
        try:
            from PIL import Image, ImageDraw, ImageFont
            
            # Criar √≠cone 512x512
            icon = Image.new('RGB', (512, 512), color='#8B2F8B')
            draw = ImageDraw.Draw(icon)
            
            # Desenhar c√≠rculo branco
            margin = 50
            draw.ellipse([margin, margin, 512-margin, 512-margin], fill='white')
            
            # Desenhar emoji/logo
            try:
                font = ImageFont.truetype("arial.ttf", 200)
            except:
                font = ImageFont.load_default()
            
            draw.text((256, 256), "üéâ", fill='#8B2F8B', anchor='mm', font=font)
            
            # Salvar em diferentes tamanhos
            icon.save('assets/icon.png')
            icon.resize((1024, 1024)).save('assets/icon-1024.png')
            icon.resize((192, 192)).save('assets/icon-192.png')
            icon.resize((144, 144)).save('assets/icon-144.png')
            icon.resize((96, 96)).save('assets/icon-96.png')
            icon.resize((72, 72)).save('assets/icon-72.png')
            icon.resize((48, 48)).save('assets/icon-48.png')
            
            # Presplash
            presplash = Image.new('RGB', (1080, 1920), color='white')
            draw_presplash = ImageDraw.Draw(presplash)
            
            # Logo no centro
            logo_resized = icon.resize((300, 300))
            presplash.paste(logo_resized, (390, 810))
            
            # Texto
            try:
                title_font = ImageFont.truetype("arial.ttf", 60)
                subtitle_font = ImageFont.truetype("arial.ttf", 30)
            except:
                title_font = ImageFont.load_default()
                subtitle_font = ImageFont.load_default()
            
            draw_presplash.text((540, 1200), "Bagun√ßArt", fill='#8B2F8B', anchor='mm', font=title_font)
            draw_presplash.text((540, 1280), "Gest√£o de Eventos", fill='#666666', anchor='mm', font=subtitle_font)
            
            presplash.save('assets/presplash.png')
            
            print("‚úÖ Assets criados com sucesso")
            
        except ImportError:
            print("‚ö†Ô∏è Pillow n√£o instalado - Criando assets b√°sicos")
            # Criar arquivos vazios
            for filename in ['icon.png', 'presplash.png']:
                with open(f'assets/{filename}', 'wb') as f:
                    f.write(b'')
    
    def run_tests(self):
        """Executar testes"""
        print("\nüß™ Executando testes...")
        
        # Criar arquivo de teste b√°sico
        test_content = '''#!/usr/bin/env python3
# test_baguncart.py - Testes b√°sicos

import unittest
import sys
import os

# Adicionar src ao path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

class TestBaguncart(unittest.TestCase):
    """Testes b√°sicos do Bagun√ßArt"""
    
    def test_imports(self):
        """Testar importa√ß√µes b√°sicas"""
        try:
            import kivy
            import kivymd
            import mysql.connector
            import bcrypt
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Erro de importa√ß√£o: {e}")
    
    def test_database_config(self):
        """Testar configura√ß√£o do banco"""
        from main import DB_CONFIG
        
        required_keys = ['host', 'port', 'database', 'user', 'password']
        for key in required_keys:
            self.assertIn(key, DB_CONFIG)
            self.assertIsNotNone(DB_CONFIG[key])
    
    def test_app_initialization(self):
        """Testar inicializa√ß√£o do app"""
        try:
            from main import BaguncartCompleteApp
            app = BaguncartCompleteApp()
            self.assertIsNotNone(app)
        except Exception as e:
            self.fail(f"Erro na inicializa√ß√£o: {e}")

if __name__ == '__main__':
    unittest.main()
'''
        
        os.makedirs('tests', exist_ok=True)
        with open('tests/test_baguncart.py', 'w') as f:
            f.write(test_content)
        
        # Executar testes
        try:
            subprocess.check_call([sys.executable, '-m', 'pytest', 'tests/', '-v'])
            print("‚úÖ Todos os testes passaram")
        except subprocess.CalledProcessError:
            print("‚ö†Ô∏è Alguns testes falharam")
        except FileNotFoundError:
            print("‚ö†Ô∏è pytest n√£o encontrado - executando testes b√°sicos")
            try:
                subprocess.check_call([sys.executable, 'tests/test_baguncart.py'])
            except:
                print("‚ö†Ô∏è Erro nos testes b√°sicos")
    
    def build_apk_debug(self):
        """Build APK debug"""
        print("\nüì± Gerando APK Debug...")
        print("‚è±Ô∏è Isso pode demorar 15-30 minutos...")
        
        try:
            # Limpar build anterior
            if os.path.exists('.buildozer'):
                shutil.rmtree('.buildozer')
            
            # Build debug
            result = subprocess.run(
                ["buildozer", "android", "debug"],
                capture_output=True,
                text=True,
                timeout=1800  # 30 minutos
            )
            
            if result.returncode == 0:
                print("‚úÖ APK Debug gerado com sucesso!")
                
                # Encontrar APK
                apk_path = None
                for root, dirs, files in os.walk('bin'):
                    for file in files:
                        if file.endswith('.apk'):
                            apk_path = os.path.join(root, file)
                            break
                
                if apk_path:
                    print(f"üìÅ APK: {apk_path}")
                    print("üì± Transfira para o celular e instale!")
                    
                    # Copiar para pasta dist
                    os.makedirs('dist', exist_ok=True)
                    shutil.copy2(apk_path, f'dist/{self.package_name}-{self.version}-debug.apk')
                    print(f"üì¶ C√≥pia salva em: dist/{self.package_name}-{self.version}-debug.apk")
                
            else:
                print("‚ùå Erro no build:")
                print(result.stderr)
                return False
                
        except subprocess.TimeoutExpired:
            print("‚è±Ô∏è Timeout - Build cancelado (muito demorado)")
            return False
        except Exception as e:
            print(f"‚ùå Erro: {e}")
            return False
        
        return True
    
    def build_apk_release(self):
        """Build APK release (para Play Store)"""
        print("\nüè™ Gerando APK Release...")
        
        # Verificar se keystore existe
        if not os.path.exists('release.keystore'):
            print("‚ö†Ô∏è Keystore n√£o encontrado!")
            print("üí° Para gerar keystore:")
            print("   keytool -genkey -v -keystore release.keystore -alias baguncart -keyalg RSA -keysize 2048 -validity 10000")
            return False
        
        try:
            result = subprocess.run(
                ["buildozer", "android", "release"],
                capture_output=True,
                text=True,
                timeout=1800
            )
            
            if result.returncode == 0:
                print("‚úÖ APK Release gerado!")
                print("üè™ Pronto para Play Store!")
            else:
                print("‚ùå Erro no build release:")
                print(result.stderr)
                return False
                
        except Exception as e:
            print(f"‚ùå Erro: {e}")
            return False
        
        return True
    
    def create_documentation(self):
        """Criar documenta√ß√£o"""
        print("\nüìö Criando documenta√ß√£o...")
        
        readme_content = f"""# {self.project_name} - Sistema de Gest√£o de Eventos

![Bagun√ßArt](assets/icon-192.png)

## üéâ Sobre o Projeto

O **Bagun√ßArt** √© um sistema moderno e completo para gest√£o de eventos, desenvolvido com **KivyMD** (Material Design 3) e **Python**. 

### ‚ú® Principais Recursos

- üé® **Interface Moderna**: Material Design 3 com anima√ß√µes fluidas
- üì± **Responsivo**: Funciona perfeitamente em mobile, tablet e desktop  
- üîç **Transpar√™ncia Total**: Clientes acompanham contratos em tempo real
- ü§ñ **Automa√ß√£o Inteligente**: Notifica√ß√µes e lembretes autom√°ticos
- üîí **Seguran√ßa**: Autentica√ß√£o robusta com bcrypt
- üåê **Cloud Ready**: Conecta com MySQL na nuvem (Aiven)

### üìã Funcionalidades

#### üë• Gest√£o de Clientes
- Cadastro completo com valida√ß√£o de CPF
- Pesquisa avan√ßada e filtros
- Hist√≥rico de contratos
- Comunica√ß√£o direta (WhatsApp)

#### üìã Contratos Inteligentes  
- Cria√ß√£o assistida de contratos
- C√°lculo autom√°tico de valores
- Gest√£o de servi√ßos
- Download de PDF

#### üîç Transpar√™ncia
- Portal do cliente
- Acompanhamento em tempo real
- Confirma√ß√µes autom√°ticas
- Hist√≥rico completo

#### üìä Relat√≥rios e Analytics
- Dashboard em tempo real
- Gr√°ficos interativos
- Exporta√ß√£o para PDF
- M√©tricas de desempenho

#### üîî Notifica√ß√µes
- Lembretes autom√°ticos
- Confirma√ß√µes de servi√ßo
- Alertas personalizados
- Integra√ß√£o WhatsApp

### üöÄ Instala√ß√£o e Uso

#### Pr√©-requisitos
- Python 3.7+
- pip
- Git

#### Instala√ß√£o R√°pida

```bash
# Clonar reposit√≥rio
git clone https://github.com/seu-usuario/baguncart.git
cd baguncart

# Instalar depend√™ncias
pip install -r requirements.txt

# Configurar ambiente
cp .env.example .env
# Edite o .env com suas configura√ß√µes

# Executar aplica√ß√£o
python main.py
```

#### üì± Gerar APK

```bash
# Instalar buildozer
pip install buildozer

# Gerar APK debug
python build_system.py --apk-debug

# Gerar APK release (Play Store)
python build_system.py --apk-release
```

### üîê Login Padr√£o

- **CNPJ**: `12345678000100`
- **Senha**: `admin123`

### üèóÔ∏è Arquitetura

```
baguncart/
‚îú‚îÄ‚îÄ main.py              # Aplica√ß√£o principal
‚îú‚îÄ‚îÄ src/                 # C√≥digo fonte
‚îÇ   ‚îú‚îÄ‚îÄ models/          # Modelos de dados
‚îÇ   ‚îú‚îÄ‚îÄ views/           # Telas da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ services/        # L√≥gica de neg√≥cio
‚îÇ   ‚îî‚îÄ‚îÄ utils/           # Utilit√°rios
‚îú‚îÄ‚îÄ assets/              # Recursos (√≠cones, imagens)
‚îú‚îÄ‚îÄ tests/               # Testes automatizados
‚îú‚îÄ‚îÄ docs/                # Documenta√ß√£o
‚îú‚îÄ‚îÄ build/               # Arquivos de build
‚îî‚îÄ‚îÄ dist/                # Distribui√ß√£o (APKs)
```

### ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

### üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para detalhes.

### üõ†Ô∏è Tecnologias Utilizadas

- **Python 3.8+**
- **Kivy 2.2.0** - Framework multiplataforma
- **KivyMD 1.2.0** - Material Design para Kivy
- **MySQL** - Banco de dados
- **bcrypt** - Criptografia de senhas
- **Buildozer** - Build para Android

### üì± Screenshots

![Dashboard](docs/screenshots/dashboard.png)
![Clientes](docs/screenshots/clientes.png)
![Transpar√™ncia](docs/screenshots/transparencia.png)

### üîó Links √öteis

- [Documenta√ß√£o KivyMD](https://kivymd.readthedocs.io/)
- [Material Design 3](https://m3.material.io/)
- [Python.org](https://python.org/)

### üìû Suporte

Para suporte e d√∫vidas:
- üìß Email: suporte@baguncart.com
- üí¨ WhatsApp: (21) 99999-9999
- üåê Site: https://baguncart.com

---

**Desenvolvido com ‚ù§Ô∏è para transformar a gest√£o de eventos**

*Bagun√ßArt - Vers√£o {self.version} - {self.build_date}*
"""
        
        with open("README.md", "w", encoding="utf-8") as f:
            f.write(readme_content)
        
        # Changelog
        changelog = f"""# Changelog - {self.project_name}

## [2.0.0] - {datetime.now().strftime("%Y-%m-%d")}

### üÜï Adicionado
- Interface completamente redesenhada com Material Design 3
- Sistema de transpar√™ncia de contratos
- Dashboard com estat√≠sticas em tempo real
- Navega√ß√£o drawer responsiva
- Anima√ß√µes fluidas e loading states
- Sistema de notifica√ß√µes inteligente
- Portal do cliente para acompanhamento
- Suporte a diferentes tamanhos de tela
- Testes automatizados
- Documenta√ß√£o completa

### üîß Melhorado  
- Performance geral da aplica√ß√£o
- Valida√ß√£o de dados mais robusta
- Sistema de autentica√ß√£o aprimorado
- Interface responsiva
- Experi√™ncia do usu√°rio

### üêõ Corrigido
- Problemas de conectividade com banco
- Bugs na valida√ß√£o de CPF
- Inconsist√™ncias na interface
- Problemas de mem√≥ria

### üîí Seguran√ßa
- Criptografia de senhas com bcrypt
- Valida√ß√£o de entrada de dados
- Prote√ß√£o contra SQL injection
- Autentica√ß√£o JWT (preparado)

## [1.0.0] - 2024-01-01

### üÜï Primeira vers√£o
- Sistema b√°sico de gest√£o
- Cadastro de clientes
- Contratos simples
- Interface inicial
"""
        
        os.makedirs("docs", exist_ok=True)
        with open("docs/CHANGELOG.md", "w", encoding="utf-8") as f:
            f.write(changelog)
        
        print("‚úÖ Documenta√ß√£o criada")
    
    def full_build(self):
        """Build completo"""
        print(f"üöÄ BUILD COMPLETO - {self.project_name}")
        print("=" * 60)
        
        try:
            # 1. Setup
            self.setup_environment()
            
            # 2. Assets
            self.create_assets()
            
            # 3. Testes
            self.run_tests()
            
            # 4. Documenta√ß√£o
            self.create_documentation()
            
            # 5. APK Debug
            if input("\\nüì± Gerar APK Debug? (s/N): ").lower() == 's':
                self.build_apk_debug()
            
            # 6. APK Release
            if input("\\nüè™ Gerar APK Release? (s/N): ").lower() == 's':
                self.build_apk_release()
            
            print("\\n" + "=" * 60)
            print("üéâ BUILD COMPLETO FINALIZADO!")
            print("=" * 60)
            print(f"üì± Projeto: {self.project_name}")
            print(f"üì¶ Vers√£o: {self.version}")
            print(f"üìÖ Data: {self.build_date}")
            print()
            print("üìÅ Arquivos gerados:")
            print("   ‚úÖ requirements.txt")
            print("   ‚úÖ buildozer.spec")
            print("   ‚úÖ .env")
            print("   ‚úÖ README.md")
            print("   ‚úÖ Assets (√≠cones)")
            print("   ‚úÖ Testes")
            print("   ‚úÖ Documenta√ß√£o")
            print()
            print("üöÄ Para executar:")
            print("   python main.py")
            print()
            print("üì± Para gerar APK:")
            print("   buildozer android debug")
            print("=" * 60)
            
        except KeyboardInterrupt:
            print("\\n‚ö†Ô∏è Build cancelado pelo usu√°rio")
        except Exception as e:
            print(f"\\n‚ùå Erro no build: {e}")

def main():
    """Fun√ß√£o principal"""
    import argparse
    
    parser = argparse.ArgumentParser(description="Sistema de Build Bagun√ßArt")
    parser.add_argument("--setup", action="store_true", help="Configurar ambiente")
    parser.add_argument("--assets", action="store_true", help="Criar assets")
    parser.add_argument("--test", action="store_true", help="Executar testes")
    parser.add_argument("--docs", action="store_true", help="Gerar documenta√ß√£o")
    parser.add_argument("--apk-debug", action="store_true", help="Gerar APK debug")
    parser.add_argument("--apk-release", action="store_true", help="Gerar APK release")
    parser.add_argument("--full", action="store_true", help="Build completo")
    
    args = parser.parse_args()
    
    builder = BaguncartBuilder()
    
    if args.setup:
        builder.setup_environment()
    elif args.assets:
        builder.create_assets()
    elif args.test:
        builder.run_tests()
    elif args.docs:
        builder.create_documentation()
    elif args.apk_debug:
        builder.build_apk_debug()
    elif args.apk_release:
        builder.build_apk_release()
    elif args.full:
        builder.full_build()
    else:
        print("üéâ Bagun√ßArt Build System")
        print("Use --help para ver op√ß√µes")
        print()
        print("Op√ß√µes r√°pidas:")
        print("  --setup       Configurar ambiente")
        print("  --apk-debug   Gerar APK debug")
        print("  --full        Build completo")

if __name__ == "__main__":
    main()